<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Paris Agreement - Entry Into Force</title>

<link rel="stylesheet" href="https://unpkg.com/tachyons@4.8.0/css/tachyons.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/jq-2.2.4/dt-1.10.15/datatables.min.css"/>
<style>
table.dataTable tr.odd {
  background-color: #eeeeee;
}
a {
  color: #ff6300;
}
hr {
  border: none;
  height: 4px;
  background-color: #333;
  margin-top: 20px;
  margin-bottom: 5px;
}
#treemap {
  position: relative;
}
.node {
  box-sizing: border-box;
  position: absolute;
  overflow: hidden;
  border: 1px solid gray;
  font-size: 9px;
}
.node-label {
  padding: 4px;
  line-height: 1.2;
  white-space: pre;
}
.node-value {
  color: rgba(0,0,0,0.8);
  margin-top: 1px;
}
.ratified .percentage-value {
  color: #ffeabc;
}
.signed .percentage-value {
  color:  #b18456;
}
.signed {
  background-color: #fdd0a2;
}
.ratified {
  background-color: #fd8d3c;
}
</style>
</head>

<body class="mb5 sans-serif">

<div class="ph4-ns ph2 mw9 pt3">
<h1 class="f1 mb0">Paris Agreement</h1>
</div>

<div class="mw9 ph3-ns">
<div class="cf ph2-ns">
<div class="fl w-100 w-50-ns pa2">
<h2>Entry Into Force <span class="gray">4 November 2016</span></h2>
<hr>
<img src="assets/pa-ratification-count.png">
</div>
<div id="column" class="fl w-100 w-50-ns pa2">
<h2><span id="ratified"></span> parties ratified</h2>
<hr>
<div id="treemap"></div>
</div>
</div>
</div>

<div class="mw9 ph3-ns">
<div class="cf ph2-ns">
<div class="fl w-100 w-50-ns pa2">
<p id="description" class="measure-wide"></p>
</div>
<div class="fl w-100 w-50-ns pa2 pt3">
<a class="f6 link dim ba ph3 pv2 mb2 dib black" href="https://github.com/openclimatedata/paris-agreement-entry-into-force"><svg class="dib h2 w2" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.083-.202-.358-1.015.077-2.117 0 0 .672-.215 2.2.82.638-.178 1.323-.266 2.003-.27.68.004 1.364.092 2.003.27 1.527-1.035 2.198-.82 2.198-.82.437 1.102.163 1.915.08 2.117.513.56.823 1.274.823 2.147 0 3.073-1.87 3.75-3.653 3.947.287.246.543.735.543 1.48 0 1.07-.01 1.933-.01 2.195 0 .215.144.463.55.385C13.71 14.53 16 11.534 16 8c0-4.418-3.582-8-8-8"/></svg> GitHub Repository</a>
</div>
</div>
</div>

<div class="mw9 ph3-ns">
<div class="cf ph2-ns">
<div class="fl w-100 w-50-ns pa2">
<h4 class="mt0 mid-gray">Sources</h4>
<ul class="list pl0" id="sources">
</ul>
</div>
<div class="fl w-100 w-50-ns pa2">
<h4 class="mt0 mid-gray">Download</h4>
<dl class="lh-title mt0">
<dt class="dib b">Data: </dt><dd class="dib ml1"><a href="data/paris-agreement-entry-into-force.csv">paris-agreement-entry-into-force.csv</a></dd>
</dl>
<dl class="lh-title mt0">
<dt class="dib b">Metadata: </dt><dd class="dib ml1"><a class="" href="datapackage.json">datapackage.json</a></dd>
</dl>
<dl class="lh-title mt0">
<dt class="dib b">Zipped Package: </dt><dd class="dib ml1"><a class="" href="https://github.com/openclimatedata/kigali-amendment-entry-into-force/archive/master.zip">master.zip</a>
</dd></dt>
</dl>
</div>
</div>
</div>

<div class="ph4-ns ph2 mw9">
<h2>Data</h2>
<hr>
<table id="entry-into-force" width="100%" cellspacing="0">
<thead>
  <tr>
    <th>Code</th>
    <th>Name</th>
    <th>Signature</th>
    <th>Ratification</th>
    <th>Kind</th>
    <th>Date of Effect</th>
    <th>Emissions</th>
    <th>Share</th>
    <th>Year</th>
  </tr>
</thead>
</table>
</div>

<div class="ph4-ns ph2 mw8">
<h2>Columns</h2>
<hr>
<table id="metadata" width="100%" cellspacing="0">
<thead>
  <tr>
    <th>Name</th>
    <th>Type</th>
    <th>Description</th>
  </tr>
</thead>
</table>
</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/jq-2.2.4/dt-1.10.15/datatables.min.js"></script>
<script>
d3.csv("data/paris-agreement-entry-into-force.csv", function(data) {
  $('table#entry-into-force').DataTable({
    data: data,
    columns: [
      { data: 'Code' },
      { data: 'Name' },
      { data: 'Signature' },
      { data: 'Ratification' },
      { data: 'Kind' },
      { data: 'Date-Of-Effect' },
      { data: 'Emissions' },
      { data: 'Percentage' },
      { data: 'Year' }
    ],
    order: [[ 3, "desc" ]],
    scrollX: true
  })
  var count = data.reduce(function(accumulator, item) {
    if (item["Ratification"] === "") {
      return accumulator
    }
    else {
      return accumulator + 1
    }
  }, 0)
  d3.select("#ratified").html(count)


  var width = parseInt(d3.select("#column").style("width")) - 15
  var height = 420
  var format = d3.format(".2f")

  var scale = d3.scaleSqrt()
    .range([9, 25])
    .domain([0, 20.09])

  var relativeArea = function(d) { return d.Percentage ? d.Percentage : 0.01 }
  var root

  var treemap = d3.treemap()
  .size([width, height])
  .padding(3)
  .paddingOuter(0)
  .tile(d3.treemapSquarify.ratio(1.4))
  .round(true)

  var styleArea = function(selection, value) {
  selection
    .style("left", function(d) { return d.x0 + "px" })
    .style("top", function(d) { return d.y0 + "px" })
    .style("width", function(d) { return d.x1 - d.x0 + "px" })
    .style("height", function(d) { return d.y1 - d.y0 + "px" })
    .style("font-size", function(d) {
        return (value === "equal") ? "9px" : scale(d.data.Percentage) + "px"
      })
  }

  var sort = function(a, b) {
    if (!a.data.Percentage & a.data.Code == "EUU") {
      a.data.Percentage = 12.1
    }
    if (!b.data.Percentage & b.data.Code == "EUU") {
      b.data.Percentage = 12.1
    }
    if (a.data.Percentage === b.data.Percentage) {
      if(a.data.Party < b.data.Party) return 1
      if(a.data.Party > b.data.Party) return -1
      return 0
    }
    else {
      return b.data.Percentage - a.data.Percentage
    }
  }

  var ratification = "Ratification"
  var eu28 = [
  'Belgium',
  'Bulgaria',
  'Denmark',
  'Germany',
  'Estonia',
  'Finland',
  'France',
  'Greece',
  'Ireland',
  'Italy',
  'Croatia',
  'Latvia',
  'Lithuania',
  'Luxembourg',
  'Malta',
  'Netherlands',
  'Austria',
  'Poland',
  'Portugal',
  'Romania',
  'Sweden',
  'Slovakia',
  'Slovenia',
  'Spain',
  'Czechia',
  'Hungary',
  'United Kingdom of Great Britain and Northern Ireland',
  'Cyprus'
]

  data.forEach(function(d) {
    if (d[ratification].length === 10) {
      d["LastUpdate"] = new Date(d[ratification])
    }
    else if (d.Signature.length === 10) {
      d["LastUpdate"] = new Date(d.Signature)
    }
    else {
      d["LastUpdate"] = NaN
    }
    if (d.Percentage) {
      d.Percentage = +d.Percentage
    }
    if (eu28.indexOf(d.Name) > -1) {
      d.parentId = "EUU"
    }
    else {
        d.parentId = "All Parties"
    }
    if (d["Code"] === "EUU") {
      d.Percentage = null
    }
  })
  data.push({"Code": "All Parties", "parentId": null})

  root = d3.stratify()
    .id(function(d) { return d["Code"] })
    (data)

  treemap(
    root
      .sum(relativeArea)
      .sort(sort)
  )

  d3.select("div#treemap")
    .style("width", (width) + "px")
    .style("height", (height) + "px")

    .selectAll(".node")
    .data(root.leaves())
    .enter().append("div")
      .attr("class", function(d) {
        if (d.data[ratification]) {
          return "node ratified"
        }
        else if (d.data.Signature) {
          return "node signed"
        }
        else {
          return "node"
        }
      })
      .attr("title", function(d) { return d.data.Name + "\n" + format(d.value) + "%" })
      .attr("id", function(d) {return d.data.Code})
      .call(styleArea)
      .style("font-size", function(d) {
        return scale(d.data.Percentage) + "px"
      })
    .append("div")
      .attr("class", "node-label")
    .append("div")
      .attr("class", "node-value")
      .html(function(d) { return d.data.Name + "<br><span class='percentage-value'>" + format(d.value) + "%</span>"})

})
d3.json("datapackage.json", function(metadata) {
  $('table#metadata').DataTable({
    data: metadata.resources[0].schema.fields,
    columns: [
      { data: 'name' },
      { data: 'type' },
      { data: 'description' }
    ],
    ordering: false,
    paging: false,
    info: false,
    searching: false,
    scrollX: true
  })
  metadata.sources.forEach(function(source) {
    d3.select("#sources").append("li").html(
      "<a href='" + source["web"] + "'>" + source["title"]) + "</a>"
  })
  d3.select("#description").html(metadata.description)
})
</script>
</body>
